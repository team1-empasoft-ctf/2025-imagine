name: Read Flag File

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  read-flag:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::396961015104:role/imaginary-challenge
          aws-region: ap-east-1

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ap-east-1 | docker login --username AWS --password-stdin 396961015104.dkr.ecr.ap-east-1.amazonaws.com

      - name: Pull challenge Docker image
        run: |
          docker pull 396961015104.dkr.ecr.ap-east-1.amazonaws.com/challenges/imaginary-challenge:latest

      - name: Extract and read the flag file
        run: |
          echo "=== Extracting and reading the not-flag-yet file ==="
          
          # Create container and extract the specific file
          CONTAINER_ID=$(docker create 396961015104.dkr.ecr.ap-east-1.amazonaws.com/challenges/imaginary-challenge:latest)
          docker cp $CONTAINER_ID:/not-flag-yet ./not-flag-yet
          docker rm $CONTAINER_ID
          
          echo "=== File content ==="
          cat not-flag-yet
          echo ""
          
          echo "=== File info ==="
          ls -la not-flag-yet
          file not-flag-yet
          
          echo "=== Hex dump (first 100 bytes) ==="
          head -c 100 not-flag-yet | xxd
          
          echo "=== Checking if it's encoded ==="
          # Check if it's base64 encoded
          if base64 -d not-flag-yet > /dev/null 2>&1; then
            echo "File appears to be base64 encoded. Decoding:"
            base64 -d not-flag-yet
            echo ""
          fi
          
          # Check if it's hex encoded
          echo "=== Trying hex decode ==="
          cat not-flag-yet | xxd -r -p 2>/dev/null | head -c 100 && echo " (hex decoded)" || echo "Not hex encoded"
          
          echo "=== Checking for common encodings ==="
          # Check for rot13
          cat not-flag-yet | tr 'A-Za-z' 'N-ZA-Mn-za-m' | head -c 50 && echo " (rot13)" || echo ""
          
          # Check for reversed text
          cat not-flag-yet | rev | head -c 50 && echo " (reversed)" || echo ""

      - name: Explore the container more thoroughly
        run: |
          echo "=== Running container to explore further ==="
          # Run the container and explore its filesystem
          docker run --rm --entrypoint /bin/sh 396961015104.dkr.ecr.ap-east-1.amazonaws.com/challenges/imaginary-challenge:latest -c "
            echo '=== Container file listing ==='
            ls -la /
            echo ''
            echo '=== Checking for other interesting files ==='
            find / -name '*flag*' -o -name '*secret*' -o -name '*.txt' -o -name '*.sh' 2>/dev/null | head -20
            echo ''
            echo '=== Environment variables ==='
            env | grep -i flag
            echo ''
            echo '=== Process list ==='
            ps aux
          "

      - name: Upload the flag file as artifact
        uses: actions/upload-artifact@v4
        with:
          name: flag-file
          path: not-flag-yet
          retention-days: 1
