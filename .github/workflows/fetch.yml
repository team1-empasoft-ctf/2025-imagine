name: Diagnose Role Permissions

on: workflow_dispatch

permissions:
  id-token: write
  contents: read

jobs:
  diagnose:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::396961015104:role/imaginary-challenge
          aws-region: us-east-1

      - name: Check Role Permissions
        run: |
          echo "=== Checking attached policies ==="
          aws iam list-attached-role-policies --role-name imaginary-challenge

          echo "=== Checking inline policies ==="
          aws iam get-role-policy --role-name imaginary-challenge --policy-name inline-policy 2>/dev/null || echo "No inline policy"

          echo "=== Listing all IAM roles (if allowed) ==="
          aws iam list-roles --query 'Roles[].RoleName' 2>/dev/null || echo "No permission to list roles"

          echo "=== Trying to get caller identity ==="
          aws sts get-caller-identity

          echo "=== Trying to list S3 buckets ==="
          aws s3 ls 2>/dev/null || echo "No S3 access"

          echo "=== Trying to list Lambda functions ==="
          aws lambda list-functions --query 'Functions[].FunctionName' 2>/dev/null || echo "No Lambda access"

          echo "=== Trying to list Secrets Manager secrets ==="
          aws secretsmanager list-secrets --query 'SecretList[].Name' 2>/dev/null || echo "No Secrets Manager access"
